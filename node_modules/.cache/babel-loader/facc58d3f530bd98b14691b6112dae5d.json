{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst composer_1 = require(\"../composer\");\n\nconst debug_1 = require(\"debug\");\n\nconst debug = (0, debug_1.default)('telegraf:scenes:context');\n\nconst noop = () => Promise.resolve();\n\nconst now = () => Math.floor(Date.now() / 1000);\n\nclass SceneContextScene {\n  constructor(ctx, scenes, options) {\n    this.ctx = ctx;\n    this.scenes = scenes;\n    this.leaving = false; // @ts-expect-error {} might not be assignable to D\n\n    const fallbackSessionDefault = {};\n    this.options = {\n      defaultSession: fallbackSessionDefault,\n      ...options\n    };\n  }\n\n  get session() {\n    var _a, _b;\n\n    const defaultSession = this.options.defaultSession;\n    let session = (_b = (_a = this.ctx.session) === null || _a === void 0 ? void 0 : _a.__scenes) !== null && _b !== void 0 ? _b : defaultSession;\n\n    if (session.expires !== undefined && session.expires < now()) {\n      session = defaultSession;\n    }\n\n    if (this.ctx.session === undefined) {\n      this.ctx.session = {\n        __scenes: session\n      };\n    } else {\n      this.ctx.session.__scenes = session;\n    }\n\n    return session;\n  }\n\n  get state() {\n    var _a;\n\n    var _b;\n\n    return (_a = (_b = this.session).state) !== null && _a !== void 0 ? _a : _b.state = {};\n  }\n\n  set state(value) {\n    this.session.state = { ...value\n    };\n  }\n\n  get current() {\n    var _a;\n\n    const sceneId = (_a = this.session.current) !== null && _a !== void 0 ? _a : this.options.default;\n    return sceneId === undefined || !this.scenes.has(sceneId) ? undefined : this.scenes.get(sceneId);\n  }\n\n  reset() {\n    if (this.ctx.session !== undefined) this.ctx.session.__scenes = this.options.defaultSession;\n  }\n\n  async enter(sceneId) {\n    let initialState = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    let silent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n\n    var _a, _b;\n\n    if (!this.scenes.has(sceneId)) {\n      throw new Error(`Can't find scene: ${sceneId}`);\n    }\n\n    if (!silent) {\n      await this.leave();\n    }\n\n    debug('Entering scene', sceneId, initialState, silent);\n    this.session.current = sceneId;\n    this.state = initialState;\n    const ttl = (_b = (_a = this.current) === null || _a === void 0 ? void 0 : _a.ttl) !== null && _b !== void 0 ? _b : this.options.ttl;\n\n    if (ttl !== undefined) {\n      this.session.expires = now() + ttl;\n    }\n\n    if (this.current === undefined || silent) {\n      return;\n    }\n\n    const handler = 'enterMiddleware' in this.current && typeof this.current.enterMiddleware === 'function' ? this.current.enterMiddleware() : this.current.middleware();\n    return await handler(this.ctx, noop);\n  }\n\n  reenter() {\n    return this.session.current === undefined ? undefined : this.enter(this.session.current, this.state);\n  }\n\n  async leave() {\n    if (this.leaving) return;\n    debug('Leaving scene');\n\n    try {\n      this.leaving = true;\n\n      if (this.current === undefined) {\n        return;\n      }\n\n      const handler = 'leaveMiddleware' in this.current && typeof this.current.leaveMiddleware === 'function' ? this.current.leaveMiddleware() : composer_1.default.passThru();\n      await handler(this.ctx, noop);\n      return this.reset();\n    } finally {\n      this.leaving = false;\n    }\n  }\n\n}\n\nexports.default = SceneContextScene;","map":{"version":3,"names":["Object","defineProperty","exports","value","composer_1","require","debug_1","debug","default","noop","Promise","resolve","now","Math","floor","Date","SceneContextScene","constructor","ctx","scenes","options","leaving","fallbackSessionDefault","defaultSession","session","_a","_b","__scenes","expires","undefined","state","current","sceneId","has","get","reset","enter","initialState","silent","Error","leave","ttl","handler","enterMiddleware","middleware","reenter","leaveMiddleware","passThru"],"sources":["/Users/mazinabed/Desktop/testingbot/node_modules/telegraf/lib/scenes/context.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst composer_1 = require(\"../composer\");\nconst debug_1 = require(\"debug\");\nconst debug = (0, debug_1.default)('telegraf:scenes:context');\nconst noop = () => Promise.resolve();\nconst now = () => Math.floor(Date.now() / 1000);\nclass SceneContextScene {\n    constructor(ctx, scenes, options) {\n        this.ctx = ctx;\n        this.scenes = scenes;\n        this.leaving = false;\n        // @ts-expect-error {} might not be assignable to D\n        const fallbackSessionDefault = {};\n        this.options = { defaultSession: fallbackSessionDefault, ...options };\n    }\n    get session() {\n        var _a, _b;\n        const defaultSession = this.options.defaultSession;\n        let session = (_b = (_a = this.ctx.session) === null || _a === void 0 ? void 0 : _a.__scenes) !== null && _b !== void 0 ? _b : defaultSession;\n        if (session.expires !== undefined && session.expires < now()) {\n            session = defaultSession;\n        }\n        if (this.ctx.session === undefined) {\n            this.ctx.session = { __scenes: session };\n        }\n        else {\n            this.ctx.session.__scenes = session;\n        }\n        return session;\n    }\n    get state() {\n        var _a;\n        var _b;\n        return ((_a = (_b = this.session).state) !== null && _a !== void 0 ? _a : (_b.state = {}));\n    }\n    set state(value) {\n        this.session.state = { ...value };\n    }\n    get current() {\n        var _a;\n        const sceneId = (_a = this.session.current) !== null && _a !== void 0 ? _a : this.options.default;\n        return sceneId === undefined || !this.scenes.has(sceneId)\n            ? undefined\n            : this.scenes.get(sceneId);\n    }\n    reset() {\n        if (this.ctx.session !== undefined)\n            this.ctx.session.__scenes = this.options.defaultSession;\n    }\n    async enter(sceneId, initialState = {}, silent = false) {\n        var _a, _b;\n        if (!this.scenes.has(sceneId)) {\n            throw new Error(`Can't find scene: ${sceneId}`);\n        }\n        if (!silent) {\n            await this.leave();\n        }\n        debug('Entering scene', sceneId, initialState, silent);\n        this.session.current = sceneId;\n        this.state = initialState;\n        const ttl = (_b = (_a = this.current) === null || _a === void 0 ? void 0 : _a.ttl) !== null && _b !== void 0 ? _b : this.options.ttl;\n        if (ttl !== undefined) {\n            this.session.expires = now() + ttl;\n        }\n        if (this.current === undefined || silent) {\n            return;\n        }\n        const handler = 'enterMiddleware' in this.current &&\n            typeof this.current.enterMiddleware === 'function'\n            ? this.current.enterMiddleware()\n            : this.current.middleware();\n        return await handler(this.ctx, noop);\n    }\n    reenter() {\n        return this.session.current === undefined\n            ? undefined\n            : this.enter(this.session.current, this.state);\n    }\n    async leave() {\n        if (this.leaving)\n            return;\n        debug('Leaving scene');\n        try {\n            this.leaving = true;\n            if (this.current === undefined) {\n                return;\n            }\n            const handler = 'leaveMiddleware' in this.current &&\n                typeof this.current.leaveMiddleware === 'function'\n                ? this.current.leaveMiddleware()\n                : composer_1.default.passThru();\n            await handler(this.ctx, noop);\n            return this.reset();\n        }\n        finally {\n            this.leaving = false;\n        }\n    }\n}\nexports.default = SceneContextScene;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}